var lookseeAngular=angular.module("lookseeAngular",["ngSanitize"]).factory("sanitizeResponse",function(){var genericError="A server error ruined the last request. :(",responseTemplate={success:!1,data:[],errors:[],malformed:!1};return{getGenericError:function(){return genericError},parse:function(response){var filtered=responseTemplate;try{response=response.data,void 0!==typeof response.success?filtered.success=Boolean(response.success):filtered.malformed=!0,void 0!==typeof response.errors&&(filtered.errors=response.errors),void 0!==typeof response.data&&(filtered.data=response.data),filtered.malformed&&!filtered.errors.length&&filtered.errors.push(genericError)}catch(e){filtered.malformed=!0,filtered.success=!1,filtered.errors=[genericError]}return filtered}}}).controller("lookseeAngularScan",function($scope,$http,$window,$timeout,sanitizeResponse){$scope.ajaxurl=$window.lookseeENV.ajaxurl,$scope.scan=$window.lookseeENV.scan,$scope.nonce=$window.lookseeENV.nonce,$scope.settings=$window.lookseeENV.settings,$scope.settingsSaved=!1,$scope.isProcessing=!1,$scope.isScanning="Scanning"===$scope.scan.status,$scope.isAborting=!1,$scope.canScan=!0,$scope.errors=[],$scope.info="Finished"===$scope.scan.status||$scope.isScanning?"":"about",$scope.scanFails=0,$scope.results={},$scope.result="",$scope.toggleInfo=function(value){$scope.info===value?$scope.info="":$scope.info=value},$scope.scanProgress=function(){return"Scanning"===$scope.scan.status&&$scope.scan.files.total&&$scope.scan.files.scanned?Math.round($scope.scan.files.scanned/$scope.scan.files.total*1e5)/1e3:0},$scope.saveSettings=function(){return $scope.isProcessing||$scope.isScanning?!1:($scope.isProcessing=!0,$scope.errors=[],void $http.post($scope.ajaxurl,$scope.settings).then(function(r){r=sanitizeResponse.parse(r),r.success?($scope.settings.onlyCore&&($scope.settings.skipSize=0,$scope.settings.skipCache=0),$scope.settingsSaved=!0,$timeout(function(){$scope.settingsSaved=!1},1e3)):$scope.errors=r.errors,$scope.isProcessing=!1},function(r){$scope.errors.push(sanitizeResponse.getGenericError()),$scope.isProcessing=!1}))},$scope.toggleScan=function(){return $scope.isProcessing?!1:void($scope.isScanning?$scope.isAborting=!0:$scope.runScan())},$scope.runScan=function(){var scanRetries=2;if(!$scope.canScan)return!1;if($scope.isAborting||$scope.scanFails===scanRetries)return $scope.isAborting=!0,$http.post($scope.ajaxurl,{action:"looksee_ajax_scan_abort",n:$scope.nonce}).then(function(r){return $scope.errors=[],r=sanitizeResponse.parse(r),r.success?($scope.scan=r.data,$scope.scanFails===scanRetries?$scope.errors.push("The server returned consecutive errors so the scan was aborted."):$scope.errors.push("The scan was aborted.")):($scope.errors=r.errors,$scope.canScan=!1),$scope.isScanning=!1,$scope.isAborting=!1,$scope.scanFails=0,!0},function(r){return $scope.errors=[sanitizeResponse.getGenericError()],$scope.isScanning=!1,$scope.isAborting=!1,$scope.scanFails=0,$scope.canScan=!1,!0}),!0;var data={action:"looksee_ajax_scan",n:$scope.nonce};$scope.isScanning||(data.start=1,$scope.isScanning=!0,$scope.scanFails=0,$scope.scan.files.total=0,$scope.scan.files.pending=0,$scope.scan.files.scanned=0),$http.post($scope.ajaxurl,data).then(function(r){$scope.errors=[],r=sanitizeResponse.parse(r);try{r.malformed||void 0!==typeof r.data.files&&r.data.files.pending!==$scope.scan.files.pending||(r.success=!1)}catch(e){r.success=!1}if(r.success){if($scope.scanFails=0,$scope.scan=r.data,!$scope.scan.status||!$scope.scan.files.total)return $scope.isScanning=!1,!0;if("Finished"===$scope.scan.status)return $scope.isScanning=!1,$scope.results={},$scope.result="",!0}else{if(data.start)return $scope.errors=r.errors,$scope.errors.push("The pre-scan could not complete."),$scope.isScanning=!1,!1;if(!r.malformed)return $scope.errors=r.errors,$scope.isScanning=!1,$scope.scanFails=0,$scope.canScan=!1,!1;$scope.scanFails++,$scope.errors.push("The last request met with an error. The scan is entering a Safe Mode that might help.")}return $scope.runScan()},function(r){return $scope.errors=[],data.start?($scope.errors.push("The pre-scan could not complete."),$scope.isScanning=!1,!1):($scope.scanFails++,$scope.errors.push("The last request met with an error. The scan is entering a Safe Mode that might help."),$scope.runScan())})},$scope.getResults=function(key){return $scope.isProcessing||!$scope.scan.summary[key].count?!1:$scope.result===key?($scope.result="",!0):($scope.result=key,void 0!==$scope.results[key]?!0:($scope.isProcessing=!0,void $http.post($scope.ajaxurl,{action:"looksee_ajax_scan_results",n:$scope.nonce,status:key}).then(function(r){$scope.errors=[],r=sanitizeResponse.parse(r),r.success?$scope.results[key]=r.data:($scope.errors=r.errors,$scope.result=""),$scope.isProcessing=!1},function(r){$scope.errors=[],$scope.errors.push(sanitizeResponse.getGenericError()),$scope.result="",$scope.isProcessing=!1})))},$timeout(function(){return $scope.isScanning?$scope.runScan():void 0})}).controller("lookseeAngularScanPlugins",function($scope,$http,$window,$timeout,sanitizeResponse){$scope.ajaxurl=$window.lookseeENV.ajaxurl,$scope.nonce=$window.lookseeENV.nonce,$scope.plugins=$window.lookseeENV.plugins,$scope.themes=$window.lookseeENV.themes,$scope.isProcessing=!0,$scope.errors=[],$scope.info="",$scope.toggleInfo=function(value){$scope.info===value?$scope.info="":$scope.info=value},$scope.getVulnerabilities=function(item,type){if(item.checked)return!1;var data={action:"looksee_ajax_scan_plugins",n:$scope.nonce,slug:item.slug,method:type};$http.post($scope.ajaxurl,data).then(function(r){$scope.errors=[],r=sanitizeResponse.parse(r),r.success?(item.checked=!0,item.vulnerabilities=r.data):$scope.errors=r.errors},function(r){$scope.errors.push(sanitizeResponse.getGenericError())})},$timeout(function(){var timeout=-1500;angular.forEach($scope.plugins,function(v,k){v.checked||$scope.errors.length||(timeout+=1500,$timeout(function(){$scope.getVulnerabilities($scope.plugins[k],"plugins")},timeout))}),angular.forEach($scope.themes,function(v,k){v.checked||$scope.errors.length||(timeout+=1500,$timeout(function(){$scope.getVulnerabilities($scope.themes[k],"themes")},timeout))})})}).controller("lookseeAngularScanConfig",function($scope,$window,$sanitize){$scope.tests=$window.lookseeENV.tests,$scope.info="",$scope.toggleInfo=function(value){$scope.info===value?$scope.info="":$scope.info=value}}).filter("round",function($filter){return function(num,places){return isNaN(num)||isNaN(places)||0>places?num:+num.toFixed(places)}}).filter("hostname",function($filter){return function(url){var tmp=document.createElement("a");return tmp.href=url,tmp.hostname||url}}).filter("byteSize",function($filter){return function(size){return isNaN(size)?size:1024>size?size+"B":1048576>size?+(size/1024).toFixed(1)+"KB":1073741824>size?+(size/1024/1024).toFixed(1)+"MB":+(size/1024/1024/1024).toFixed(1)+"GB"}}).config(function($httpProvider){$httpProvider.defaults.transformRequest=function(data){return void 0===data?data:jQuery.param(data)},$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8"});